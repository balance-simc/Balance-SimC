<html>
<head>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@2.2.1/src/js.cookie.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js" charset="utf-8"></script>
    <script src="pivot.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pivottable/2.23.0/plotly_renderers.min.js"></script>
    <link rel="stylesheet" type="text/css" href="pivot.css">

    <script>
        $(function() {
            var payload;
            var defaultLayout = {
                rows: ["cov", "soul", "cond1"],
                cols: ["leg"],
                rowOrder: "value_z_to_a",
                colOrder: "value_z_to_a",
                rendererName: "Heatmap",
                exclusions: {}
            }

            let rend = $.pivotUtilities.renderers;
            let plot = $.pivotUtilities.plotly_renderers;
            delete rend["Table Barchart"];
            rend["Vertical Bar"] = plot["Bar Chart"];
            rend["Horizontal Bar"] = plot["Horizontal Bar Chart"];
            rend["Line Chart"] = plot["Line Chart"];
            rend["Area Chart"] = plot["Area Chart"];

            var defaultOptions = {
                renderers: rend,
                hiddenFromDragDrop: ["dps"],
                hiddenFromAggregators: ["cov", "soul", "cond1", "cond2", "leg", "tal"],
                rows: ["cov", "soul", "cond1"],
                cols: ["leg"],
                rowOrder: "value_z_to_a",
                colOrder: "value_z_to_a",
                aggregators: {
                    "DPS": function() {
                        return $.pivotUtilities.aggregatorTemplates.max()(["dps"])
                    }
                },
                vals: ["dps"],
                rendererOptions: {
                    heatmap: {
                        colorScaleGenerator: function(val) {
                            let min = Math.min(...val);
                            let max = Math.max(...val);
                            return Plotly.d3.scale.linear()
                                .domain([min, max])
                                .range(["#FFFFFF", "#FF7D0A"])
                        }
                    }
                }
            }

            function load_json(url) {
                $.getJSON(url, function(json) {
                    payload = json;

                    $("#pivot").pivotUI(json, $.extend({}, defaultOptions, defaultLayout));
                });
            }

            load_json($("#fightstyle").val());

            $("#fightstyle").change(function() {
                load_json($(this).val());
            });

            $("#save").on("click", function() {
                let config = $("#pivot").data("pivotUIOptions");
                let config_copy = {};

                config_copy["rows"] = config.rows;
                config_copy["cols"] = config.cols;
                config_copy["rowOrder"] = config.rowOrder;
                config_copy["colOrder"] = config.colOrder;
                config_copy["rendererName"] = config.rendererName
                config_copy["exclusions"] = config.exclusions;

                Cookies.set("pivotLayout", JSON.stringify(config_copy));
            });
            $("#load").on("click", function() {
                let config = $("#pivot").data("pivotUIOptions");

                $("#pivot").pivotUI(payload, $.extend(config, JSON.parse(Cookies.get("pivotLayout"))), true);
            });
            $("#clear").on("click", function() {
                Cookies.remove("pivotLayout");
            });
            $("#reset").on("click", function() {
                let config = $("#pivot").data("pivotUIOptions");

                $("#pivot").pivotUI(payload, $.extend(config, defaultOptions), true);
            });

            $("#nav a.load").click(function(event) {
                $("#main").remove();
                $(".frames").width("100%");
                $("#side").height("96vh");
            })
        });
        (async () => {
            const response = await fetch('https://api.github.com/repos/balance-simc/Balance-SimC/contents/');
            const data = await response.json();
            let htmlString = '<ul>';
            for (let file of data) {
                let ext = file.name.split('.').pop();
                if (ext == 'txt') {
                    htmlString += `<li><a href="${file.name}">${file.name}</a></li>`;
                }
            }
            htmlString += '</ul>';
            document.getElementById('dir').innerHTML = htmlString;
        })()
    </script>
</head>
<body>
    <div style="display: flex">
        <div id="nav">
            <div><a href="pivot.html"><b>Charts</b></a></div>
            <div><a class="load" href="md.html?file=faq.txt" target="frame"><b>FAQ</b></a></div>
            <div><a class="load" href="md.html?file=balance.txt" target="frame"><b>Balance&nbsp;APL</b></a></div>
            <div><a href="https://github.com/balance-simc/Balance-SimC/issues/new/choose"><b>Report&nbsp;Issue</b></a></div>
            <div><a class="load" href="by_talent.html" target="frame"><b>Detailed&nbsp;Sims</b></a></div>
            <div id="dir"></div>
        </div>
        <div id="main">
            <div class="title">Balance Druid Shadowlands DPS Charts
            <select id="fightstyle">
                <option value="combo_h_1.json">Heroic 1 Target</option>
                <option value="combo_h_2.json">Heroic 2 Targets</option>
                <option value="combo_h_3.json">Heroic 3 Targets</option>
                <option value="combo_h_4.json">Heroic 4 Targets</option>
                <option value="combo_h_5.json">Heroic 5 Targets</option>
                <option value="combo_h_1m.json">Heroic 1T Move</option>
                <option value="combo_h_s.json">Heroic 2T Spread</option>
                <option value="combo_h_d.json">Heroic Dungeon</option>
                <option value="combo_1.json">Mythic 1 Target</option>
                <option value="combo_2.json">Mythic 2 Targets</option>
                <option value="combo_3.json">Mythic 3 Targets</option>
                <option value="combo_4.json">Mythic 4 Targets</option>
                <option value="combo_5.json">Mythic 5 Targets</option>
                <option value="combo_1m.json">Mythic 1T Move</option>
                <option value="combo_s.json">Mythic 2T Spread</option>
                <option value="combo_d.json">Mythic Dungeon</option>
            </select>
            </div>
            <div class="buttons">
                <input type="button" value="Reset Layout" id="reset" />
                <input type="button" value="Save Layout" id="save" />
                <input type="button" value="Load Layout" id="load" />
                <input type="button" value="Clear Saved" id="clear" />
            </div>
            <div id="pivot"></div>
        </div>
        <div class="frames">
            <iframe id="side" name="frame" style="flex-grow: 1;"></iframe>
        </div>
    </div>
</body>
</html>
